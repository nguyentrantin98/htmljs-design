var _=Object.defineProperty;var A=(h,n,t)=>n in h?_(h,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[n]=t;var b=(h,n,t)=>(A(h,typeof n!="symbol"?n+"":n,t),t);import{P as T,L as D,H as v,a as x,U as O,C}from"./index-jL8zU13h.js";const c=class c extends T{constructor(n){super("Component"),this.Name="Export CustomData",this.Title="Xuất excel tùy chọn",document.addEventListener("DOMContentLoaded",()=>{this.LocalRender()}),this.ParentListView=n,this._tbody=null,this._headers=[],this._userSetting=null,this._table=null,this._hasLoadSetting=!1}Move(){const n=this,t=this._table;let e,o,l,i,p=!1,f=0,g=0;const u=function(r,s){const a=r.parentNode,d=r.nextSibling===s?r:r.nextSibling;s.parentNode.insertBefore(r,s),a.insertBefore(s,d)},y=function(r,s){const a=r.getBoundingClientRect(),d=s.getBoundingClientRect();return a.top+a.height/2<d.top+d.height/2},P=function(){t.getBoundingClientRect();const r=parseInt(window.getComputedStyle(t).width);i=document.createElement("div"),i.classList.add("clone-list"),i.style.position="absolute",t.parentNode.insertBefore(i,t),t.style.visibility="hidden",t.querySelectorAll("tr").forEach(function(s){const a=document.createElement("div");a.classList.add("draggable");const d=document.createElement("table");d.setAttribute("class","clone-table"),d.style.width=`${r}px`;const w=document.createElement("tr");Array.from(s.children).forEach(function(m){if(m instanceof HTMLElement){const E=m.cloneNode(!0);E instanceof HTMLElement&&(E.style.width=`${parseInt(window.getComputedStyle(m).width)}px`,w.appendChild(E))}}),d.appendChild(w),a.appendChild(d),i.appendChild(a)})},N=function(r){const s=r.target.parentNode;o=Array.from(t.querySelectorAll("tr")).indexOf(s),f=r.clientX,g=r.clientY,document.addEventListener("mousemove",S),document.addEventListener("mouseup",L)},S=function(r){p||(p=!0,P(),e=Array.from(i.children)[o],e.classList.add("dragging"),l=document.createElement("div"),l.classList.add("placeholder"),e.parentNode.insertBefore(l,e.nextSibling),l.style.height=`${e.offsetHeight}px`),e.style.position="absolute",e.style.top=`${e.offsetTop+r.clientY-g}px`,e.style.left=`${e.offsetLeft+r.clientX-f}px`,f=r.clientX,g=r.clientY;const s=e.previousElementSibling,a=l.nextElementSibling;s&&s.previousElementSibling&&y(e,s)&&(u(l,e),u(l,s)),a&&y(a,e)&&(u(a,l),u(a,e))},L=function(){l&&l.parentNode.removeChild(l),e.classList.remove("dragging"),e.style.removeProperty("top"),e.style.removeProperty("left"),e.style.removeProperty("position");const r=Array.from(i.children).indexOf(e);p=!1,i.parentNode.removeChild(i);let s=Array.from(t.querySelectorAll("tr"));o>r?s[r].parentNode.insertBefore(s[o],s[r]):s[r].parentNode.insertBefore(s[o],s[r].nextSibling),t.style.removeProperty("visibility"),document.removeEventListener("mousemove",S),document.removeEventListener("mouseup",L),n.OrderBy()};t.querySelectorAll("tr").forEach(function(r,s){if(s===0)return;const a=r.firstElementChild;a.classList.add("draggable"),a.addEventListener("mousedown",N)})}LocalRender(){this.ParentListView instanceof D&&this.ParentListView.GetUserSetting(c.Prefix).then(n=>this.UserSettingLoaded(n,!0))}UserSettingLoaded(n,t=!0){if(this._hasLoadSetting=!0,this._userSetting=n[0].length>0?n[0][0]:null,this._userSetting){let o=JSON.parse(this._userSetting.Value).reduce((l,i)=>(l[i.Id]=i,l),{});this._headers.forEach(l=>{l.IsExport=!0;let i=o[l.Id];i&&(l.IsExport=i.IsExport,l.OrderExport=i.OrderExport)})}if(this._headers.sort((o,l)=>o.OrderExport-l.OrderExport),!t)return;let e=this.FindComponentByName("Content");e.Element.classList.add("table"),this._table=e.Element,this.RenderDetails(),this.Move()}SetChecked(n,t){n.IsExport=t.target.checked,this.Dirty=!0}DirtyCheckAndCancel(){this.Dirty=!0,super.DirtyCheckAndCancel()}RenderDetails(){v.Take(this._tbody).Clear();let n=1;for(let t of this._headers)v.Instance.TRow.DataAttr("id",t.Id).TData.DataAttr("id",t.Id).Style("padding:0").IText(n.toString()).End.TData.Style("padding:0").Checkbox(t.IsExport).Event("input",e=>t.IsExport=e.target.checked).End.End.TData.Style("padding:0").ClassName("text-left").IText(t.Label).End.EndOf("tr"),n++;this.Move()}OrderBy(){let n=1;Array.from(this._tbody.children).forEach(t=>{const e=this._headers.find(o=>o.Id===t.getAttribute("data-id"));e&&(e.OrderExport=n,n++)})}ExportAll(){this.Export()}ExportSelected(){if(this.ParentListView.SelectedIds.length===0){x.Warning("Select at least 1 row to export");return}this.Export(null,null,this.ParentListView.SelectedIds)}Export(n=null,t=null,e=null){if(x.Success("Đang xuất excel"),this._hasLoadSetting&&this.Dirty){this.ParentListView.UpdateSetting(this._userSetting,c.Prefix,JSON.stringify(this._headers)).then(()=>{this.ExportWithSetting(n,t,e)});return}this.ParentListView.GetUserSetting(c.Prefix).then(o=>{this.UserSettingLoaded(o,!1),this.ExportWithSetting(n,t,e)})}ExportWithSetting(n,t,e){let o=this.ParentListView.GetSql(n,t);if(o.Count=!1,this._headers.some(i=>i.IsExport)&&(o.FieldName=this._headers.filter(i=>i.IsExport).map(i=>i.FieldText.trim()===""?i.FieldName:i.FieldText),o.Select=this._headers.some(i=>i.FieldName)?o.FieldName.join(", "):null),e.length>0){let i=e.join(", ");o.Where=`Id in (${i})`}o.Params=this.ParentListView.Meta.Label||this.ParentListView.Meta.RefName,o.Table=this.ParentListView.Meta.RefName;let l={Value:JSON.stringify(o),Url:O.ExportExcel,IsRawString:!0,Method:"POST"};C.Instance.SubmitAsync(l).then(i=>{C.Download(`/excel/Download/${i}`),x.Success("Xuất file thành công")})}};b(c,"Prefix","Export");let I=c;export{I as ExportCustomData};
